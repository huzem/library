<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dijital K√ºt√ºphane - HUZEM</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
:root{
  --bordo:#7a0c18;
  --bordo2:#9c1a2b;
  --bg:#f4f4f4;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Segoe UI",sans-serif;
}

body{
  background:var(--bg);
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none; 
}

/* HEADER */
header{
  background:linear-gradient(90deg,var(--bordo),var(--bordo2));
  color:white;
  padding:16px 20px;
  text-align:center;
  letter-spacing:.5px;
}

.header-top{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  flex-wrap:wrap;
}

.header-top img{
  height:60px;
}

.header-title{
  font-size:24px;
  font-weight:bold;
}

.header-subtitle{
  font-size:16px;
  margin-top:4px;
  font-weight:500;
}

/* K√úT√úPHANE IZGARASI */
.library{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:30px;
  padding:40px;
}

.book{
  background:white;
  border-radius:12px;
  padding:12px;
  cursor:pointer;
  transition:.3s;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

.book:hover{
  transform:translateY(-8px) scale(1.03);
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
}

.book img{
  width:100%;
  height:220px;
  object-fit:cover;
  border-radius:8px;
}

.book-title{
  margin-top:8px;
  font-weight:600;
  font-size:15px;
  text-align:center;
}

.book-author{
  font-size:12px;
  color:#666;
  text-align:center;
}

/* MODAL & PDF G√ñR√úNT√úLEYƒ∞Cƒ∞ */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  display:none;
  flex-direction:column;
  z-index: 9999;
}

.modal-content {
  display: flex;
  flex: 1;
  gap: 0;
  min-height: 0;
  overflow: hidden;
}

.pdf-viewer-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  min-height: 0;
  overflow-y: auto;
}

.comments-sidebar {
  width: 380px;
  background: white;
  border-left: 2px solid var(--bordo);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.modal-header{
  background:var(--bordo);
  color:white;
  padding:12px 20px;
  font-size:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.close-btn{
  background:white;
  border:none;
  padding:6px 12px;
  font-weight:bold;
  cursor:pointer;
  border-radius:6px;
  color: var(--bordo);
}

/* PDF CONTAINER */
.viewer-container {
    flex: 1;
    overflow-y: auto;
    background: #525659;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    position: relative;
    min-height: 0;
}

/* SAYFA YAPISI (Canvas + Link Katmanƒ± i√ßin Wrapper) */
.page-wrapper {
    position: relative; /* Linklerin buna g√∂re konumlanmasƒ± i√ßin ≈üart */
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

/* Canvas (G√∂r√ºnt√º) */
.pdf-page-canvas {
    display: block;
    max-width: 100%;
    pointer-events: none; /* Resmi se√ßmeyi engelle */
}

/* Link Katmanƒ± */
.link-layer {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    /* Renk yok, tamamen ≈üeffaf */
}

/* Link Kutucuklarƒ± */
.pdf-link {
    position: absolute;
    cursor: pointer;
    background: rgba(255, 255, 0, 0); /* G√∂r√ºnmez */
    transition: background 0.2s;
}
/* √úzerine gelince belli olsun isterseniz a√ßabilirsiniz: */
.pdf-link:hover {
    background: rgba(255, 255, 0, 0.2); 
    border: 1px solid rgba(0,0,0,0.2);
}

/* WATERMARK (Her zaman sabit g√∂r√ºnen filigran) */
.watermark-overlay {
    position: fixed; /* 'absolute' yerine 'fixed' yaparak ekrana sabitledik */
    top: 60px;       /* Header'ƒ±n altƒ±nda ba≈ülamasƒ± i√ßin (Header y√ºksekliƒüine g√∂re ayarlayƒ±n) */
    left: 0; 
    right: 0; 
    bottom: 0;
    pointer-events: none; /* Linklere tƒ±klamayƒ± engellemez, sadece √ºstte g√∂r√ºn√ºr */
    z-index: 1000;       /* Her ≈üeyin (PDF sayfalarƒ±nƒ±n ve linklerin) en √ºst√ºnde durmasƒ± i√ßin */
    overflow: hidden;
    opacity: 0.3;        /* G√∂r√ºn√ºrl√ºk derecesi */
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' height='150px' width='150px'><text transform='translate(20, 100) rotate(-45)' fill='white' font-size='20' font-family='Arial'>HUZEM¬©</text></svg>");
}

.loading {
    color: white;
    font-size: 18px;
    margin-top: 50px;
    font-weight: bold;
}

/* SAƒû TIK VE S√úR√úKLEME ENGELƒ∞ */
img, canvas, .viewer-container {
  -webkit-user-drag: none;
  user-drag: none;
}

/* YORUM Sƒ∞STEMƒ∞ */
.comments-section {
  display: none;
}

.comments-sidebar {
  padding: 15px;
  background: white;
  border-left: 2px solid var(--bordo);
  display: flex;
  flex-direction: column;
}

.comment-action-btn {
  background: var(--bordo);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: 0.3s;
}

.comment-action-btn:hover {
  background: var(--bordo2);
  transform: translateY(-2px);
}

.comment-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 20px;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--bordo);
}

.comment-form input,
.comment-form textarea {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
}

.comment-form textarea {
  resize: vertical;
  min-height: 80px;
}

.comment-form button {
  background: var(--bordo);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.comment-form button:hover {
  background: var(--bordo2);
}

.comments-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.comment-item {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 6px;
  border-left: 3px solid var(--bordo);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.comment-author {
  font-weight: 600;
  color: var(--bordo);
  font-size: 14px;
}

.comment-text {
  margin: 8px 0;
  color: #333;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.comment-date {
  font-size: 12px;
  color: #999;
}

.comments-loading {
  text-align: center;
  color: #999;
  font-size: 14px;
  padding: 20px;
}
</style>
</head>
<body oncontextmenu="return false">

<header>
  <div class="header-top">
    <img src="https://hitit.edu.tr/images/HititLogoYeni.svg" alt="Hitit √úniversitesi Logo">
    <div>
      <div class="header-title">Uzaktan Eƒüitim Uygulama ve Ara≈ütƒ±rma Merkezi (HUZEM)</div>
      <div class="header-subtitle">Kaynak K√ºt√ºphanesi</div>
    </div>
  </div>
</header>

<div class="library" id="library"></div>

<div class="modal" id="modal">
  <div class="modal-header">
    <span id="modalTitle">Kitap Okuyucu</span>
    <button class="close-btn" onclick="closeViewer()">Kapat</button>
  </div>
  
  <div class="modal-content">
    <div class="pdf-viewer-section">
      <div class="viewer-container" id="pdfContainer">
        <div id="loadingText" class="loading">Kitap Y√ºkleniyor...</div>
        <div class="watermark-overlay"></div>
      </div>
    </div>

    <div class="comments-sidebar" id="commentsSection">
      <h3 style="color: var(--bordo); margin-bottom: 12px; padding: 15px 15px 0 15px; font-size: 16px;">üí¨ Yorum</h3>
      
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSey6PHs6VUzsog_8-mWaszOlSGWyb7bi64Szra7p0VodsJm7A/viewform?embedded=true" width="100%" height="900" frameborder="0" marginheight="0" marginwidth="0" style="border: none; flex-shrink: 0;">Y√ºkleniyor‚Ä¶</iframe>
    </div>
  </div>
</div>

<script>
const books = [
  {
    title:"Mod√ºl 1: Yapay Zek√¢ ve Eƒüitim",
    author:"HUZEM",
    cover:"kapaklar/ai1.png",
    file:"kitaplƒ±k/ai1.pdf"
  },
  {
    title:"Mod√ºl 2: Y√ºksek√∂ƒüretimde Yapay Zek√¢ Destekli √ñƒüretim",
    author:"HUZEM",
    cover:"kapaklar/ai2.png",
    file:"kitaplƒ±k/ai2.pdf"
  },
  {
    title:"Mod√ºl 3: Y√ºksek√∂ƒüretimde Kullanƒ±labilecek Yapay Zek√¢ Uygulamalarƒ±",
    author:"HUZEM",
    cover:"kapaklar/ai3.png",
    file:"kitaplƒ±k/ai3.pdf"
  },
    {
    title:"Mod√ºl 4: Y√ºksek√∂ƒüretimde Yapay Zek√¢ Ara√ßlarƒ±nƒ±n √ñƒüretim Uygulamalarƒ±na Entegrasyonu",
    author:"HUZEM",
    cover:"kapaklar/ai4.png",
    file:"kitaplƒ±k/ai4.pdf"
  },
    {
    title:"Mod√ºl 1: √ñl√ßme ve Deƒüerlendirmede Temel Kavramlar",
    author:"HUZEM",
    cover:"kapaklar/ytd1.png",
    file:"kitaplƒ±k/ytd1.pdf"
  },
  {
    title:"Mod√ºl 2: Yeterlilik ve Performans Temelli √ñl√ßme-Deƒüerlendirmeye Giri≈ü",
    author:"HUZEM",
    cover:"kapaklar/ytd2.png",
    file:"kitaplƒ±k/ytd2.pdf"
  },
  {
    title:"Mod√ºl 3: Yeterlilik Temelli √ñl√ßme-Deƒüerlendirme Y√∂ntemleri, Stratejileri ve Puanlama Ara√ßlarƒ±",
    author:"HUZEM",
    cover:"kapaklar/ytd3.png",
    file:"kitaplƒ±k/ytd3.pdf"
  },
  {
    title:"Mod√ºl 4: Performans Deƒüerlendirmede Etkili ve Nitelikli Geribildirim Verme Rehberi",
    author:"HUZEM",
    cover:"kapaklar/ytd4.png",
    file:"kitaplƒ±k/ytd4.pdf"
  },
  {
    title:"Mod√ºl 5: Eƒüitici Eƒüitimleri Sonucunda Birimlerden Gelen Uygulama √ñrnekleri",
    author:"HUZEM",
    cover:"kapaklar/ytd5.png",
    file:"kitaplƒ±k/ytd5.pdf"
  },
];

const library = document.getElementById("library");
const modal = document.getElementById("modal");
const pdfContainer = document.getElementById("pdfContainer");
const title = document.getElementById("modalTitle");
const loadingText = document.getElementById("loadingText");

books.forEach((b,i)=>{
  const el = document.createElement("div");
  el.className="book";
  el.innerHTML=`
    <img src="${b.cover}" onerror="this.src='https://via.placeholder.com/160x220?text=Kapak+Yok'">
    <div class="book-title">${b.title}</div>
    <div class="book-author">${b.author}</div>
  `;
  el.onclick=()=>loadPDF(b);
  library.appendChild(el);
});

async function loadPDF(book) {
    modal.style.display = "flex";
    title.textContent = book.title;
    loadingText.style.display = "block";
    
    // Yorumlar i√ßin kitap bilgisini kaydet
    currentBook = book;
    
    // Eski sayfalarƒ± temizle (wrapper'larƒ± siliyoruz)
    const oldPages = document.querySelectorAll('.page-wrapper');
    oldPages.forEach(el => el.remove());

    try {
        const loadingTask = pdfjsLib.getDocument(book.file);
        const pdf = await loadingTask.promise;
        
        loadingText.style.display = "none";

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });

            // 1. Wrapper Olu≈ütur (Canvas + Linkler bunun i√ßinde duracak)
            const wrapper = document.createElement("div");
            wrapper.className = "page-wrapper";
            wrapper.style.width = viewport.width + "px";
            wrapper.style.height = viewport.height + "px";

            // 2. Canvas Olu≈ütur
            const canvas = document.createElement("canvas");
            canvas.className = "pdf-page-canvas";
            const context = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // 3. Link Katmanƒ± Olu≈ütur
            const linkLayer = document.createElement("div");
            linkLayer.className = "link-layer";

            // 4. Sayfadaki Linkleri Bul ve Ekle
            const annotations = await page.getAnnotations();
            
            annotations.forEach(annotation => {
                if (annotation.subtype === 'Link' && annotation.url) {
                    // PDF koordinatlarƒ±nƒ± Canvas koordinatlarƒ±na √ßevir
                    // rect: [x_min, y_min, x_max, y_max] (PDF koordinat sistemi)
                    // Viewport bu √ßeviriyi bizim i√ßin yapar
                    const rect = viewport.convertToViewportRectangle(annotation.rect);
                    
                    // rect dizisinden CSS pozisyonlarƒ±nƒ± hesapla
                    // convertToViewportRectangle sonrasƒ±: [x1, y1, x2, y2]
                    // Genelde [left, bottom, right, top] ≈üeklinde d√∂ner (Canvas'ta Y ekseni terstir)
                    
                    // En g√ºvenli koordinat hesaplama (Normalize etme):
                    const x = Math.min(rect[0], rect[2]);
                    const y = Math.min(rect[1], rect[3]); // Y ekseninde en √ºst nokta (k√º√ß√ºk olan)
                    const width = Math.abs(rect[2] - rect[0]);
                    const height = Math.abs(rect[3] - rect[1]);

                    const link = document.createElement("a");
                    link.href = annotation.url;
                    link.target = "_blank"; // Yeni sekmede a√ß
                    link.className = "pdf-link";
                    link.title = annotation.url; // √úzerine gelince link g√∂r√ºns√ºn
                    
                    link.style.left = x + "px";
                    link.style.top = y + "px";
                    link.style.width = width + "px";
                    link.style.height = height + "px";

                    linkLayer.appendChild(link);
                }
            });

            // Elemanlarƒ± birle≈ütir
            wrapper.appendChild(canvas);
            wrapper.appendChild(linkLayer);
            
            // Container'a ekle
            pdfContainer.appendChild(wrapper);

            // Render i≈ülemi (Asenkron)
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
        }
    } catch (error) {
        console.error("PDF Hatasƒ±:", error);
        loadingText.textContent = "PDF y√ºklenemedi. Dosya yolunu kontrol edin.";
    }
}

function closeViewer(){
  modal.style.display="none";
}

// ==================== YORUM Sƒ∞STEMƒ∞ (LocalStorage + JSON) ====================
let currentBook = null;
let allComments = [];
let commentsRefreshInterval = null;

const commentText = document.getElementById("commentText");
if (commentText) {
  commentText.addEventListener("input", function() {
    const remaining = 500 - this.value.length;
    document.getElementById("charCount").textContent = remaining;
  });
}

function showViewComments() {
  document.getElementById("commentsView").style.display = "block";
  document.getElementById("commentForm").style.display = "none";
  loadAllComments();
  
  // Arkaplanda her 3 saniyede JSON'u refresh et
  if (commentsRefreshInterval) clearInterval(commentsRefreshInterval);
  commentsRefreshInterval = setInterval(() => {
    if (document.getElementById("commentsView").style.display === "block") {
      loadAllComments();
    }
  }, 3000);
}

function showWriteComment() {
  document.getElementById("commentForm").style.display = "block";
  document.getElementById("commentsView").style.display = "none";
  document.getElementById("commentName").focus();
}

function hideComments() {
  document.getElementById("commentsView").style.display = "none";
  document.getElementById("commentForm").style.display = "none";
  if (commentsRefreshInterval) clearInterval(commentsRefreshInterval);
}

async function loadAllComments() {
  const commentsList = document.getElementById("commentsList");

  try {
    // JSON dosyasƒ±ndan yorumlarƒ± fetch et
    const response = await fetch('comments.json');
    const jsonData = await response.json();
    
    // localStorage'deki yorumlarƒ± al
    const localComments = JSON.parse(localStorage.getItem('comments') || '[]');
    
    // Kitab i√ßin filtrelenmi≈ü yorumlarƒ± birle≈ütir
    const bookKey = currentBook.file.replace(/\//g, '_').replace(/\./g, '_');
    const jsonCommentsForBook = (jsonData.comments || []).filter(c => c.bookKey === bookKey);
    const localCommentsForBook = localComments.filter(c => c.bookKey === bookKey);
    
    allComments = [...jsonCommentsForBook, ...localCommentsForBook].sort((a, b) => {
      return new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp);
    });

    if (allComments.length === 0) {
      if (commentsList.innerHTML !== '<div class="comments-loading">Hen√ºz yorum yapƒ±lmamƒ±≈ü. ƒ∞lk yorum siz yapƒ±n!</div>') {
        commentsList.innerHTML = '<div class="comments-loading">Hen√ºz yorum yapƒ±lmamƒ±≈ü. ƒ∞lk yorum siz yapƒ±n!</div>';
      }
      return;
    }

    commentsList.innerHTML = '';
    allComments.forEach(comment => {
      const commentEl = document.createElement('div');
      commentEl.className = 'comment-item';
      
      const dateStr = new Date(comment.date || comment.timestamp).toLocaleString('tr-TR');
      const badge = comment.isLocal ? ' <span style="background: #fff3cd; color: #856404; font-size: 11px; padding: 2px 6px; border-radius: 3px; margin-left: 8px;">Yerel</span>' : '';
      
      commentEl.innerHTML = `
        <div class="comment-author">${comment.author || 'Anonim'}${badge}</div>
        <div class="comment-text">${escapeHtml(comment.text)}</div>
        <div class="comment-date">${dateStr}</div>
      `;
      
      commentsList.appendChild(commentEl);
    });
  } catch (error) {
    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = '<div class="comments-loading">‚ö†Ô∏è Yorumlar y√ºklenemedi (comments.json dosyasƒ± bulunamadƒ±)</div>';
    console.error('Yorum y√ºkleme hatasƒ±:', error);
  }
}

function postComment() {
  const nameInput = document.getElementById("commentName");
  const textInput = document.getElementById("commentText");
  
  const author = nameInput.value.trim() || "Anonim";
  const text = textInput.value.trim();

  if (!text) {
    alert("L√ºtfen bir yorum yazƒ±n!");
    return;
  }

  if (text.length > 500) {
    alert("Yorum en fazla 500 karakter olmalƒ±!");
    return;
  }

  try {
    const bookKey = currentBook.file.replace(/\//g, '_').replace(/\./g, '_');
    const newComment = {
      bookKey: bookKey,
      author: author,
      text: text,
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleString('tr-TR'),
      isLocal: true
    };

    // localStorage'e ekle
    const comments = JSON.parse(localStorage.getItem('comments') || '[]');
    comments.push(newComment);
    localStorage.setItem('comments', JSON.stringify(comments));

    // Formu temizle
    textInput.value = '';
    nameInput.value = '';
    document.getElementById("charCount").textContent = '500';

    alert("‚úÖ Yorum kaydedildi!");
    
    // Otomatik "Yorumlarƒ± G√∂r" a√ßƒ±l
    showViewComments();
  } catch (error) {
    alert("Yorum kaydedilemedi: " + error.message);
    console.error('Yorum g√∂nderme hatasƒ±:', error);
  }
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
// ==================== YORUM Sƒ∞STEMƒ∞ END ====================



// G√ºvenlik Kƒ±sƒ±tlamalarƒ± (Aynen devam)
document.addEventListener('contextmenu', event => event.preventDefault());

document.addEventListener("keydown", function(e){
    if (e.ctrlKey && (e.key === 'c' || e.key === 's' || e.key === 'p' || e.key === 'u' || e.key === 'a')) {
        e.preventDefault();
        return false;
    }
    if (e.key === "PrintScreen") {
        navigator.clipboard.writeText("");
        modal.style.display = 'none';
        setTimeout(() => { modal.style.display = 'flex'; }, 500);
    }
});
</script>

</body>
</html>
